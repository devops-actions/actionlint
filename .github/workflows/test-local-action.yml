name: Test local action
on:
  push:

  pull_request:
  
jobs:
  test-local-action:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Run the local action from the checked out branch
        id: action-lint
        uses: ./
            
      - name: Check for no reported errors
        if: steps.action-lint.outcome=='success'
        run: |
          echo "Error in 'action-lint' step, expected a failure status, but got success"
          # fail the job so reporting can pick it up
          exit 1
      
      - name: Check for expected errors
        if: always() && steps.action-lint.outcome=='failure'
        run: |
          echo "Todo: check the results of fake-output and fake-secret"
      
      - name: Test output file and expected contents
        if: always()
        shell: pwsh
        env:
          RESULTFILE: ${{ steps.action-lint.outputs.results-file }}
        run: |
          echo "Results file is [$env:RESULTFILE]"
          $result = Get-Content $env:RESULTFILE       
          $items = @(ConvertFrom-Json $result -Depth 10)     
      
          $found1 = $false
          $found2 = $false
          foreach ($item in $items) { 
            Write-Host "Found an error: "
            Write-Host "Message:" $item.message
            Write-Host "Filepath:" $item.filepath
            Write-Host "Line:" $item.line

            if ($item.filepath -eq '.github/workflows/workflow-with-errors.yml' -and $item.line -eq 12) {
              Write-Host "Found first file path and line number"
              if ($item.message -eq 'property \"test-local-action\" is not defined in object type {}') { 
                $found1 = $true
                Write-Host "found nr 1"
              }
              else {
                Write-Host "Expected message not found"
                Write-Host "got      [$($item.message)]"
                Write-Host "Expected [$('property ""test-local-action"" is not defined in object type {}')]"
                Write-Host "Expected [$('property \"test-local-action\" is not defined in object type {}')]"
              }
            }

            if ($item.filepath -eq '.github/workflows/workflow-with-errors.yml' -and $item.line -eq 18) {
              Write-Host "Found second file path and line number"
              if ($item.message -eq 'property ""test-job"" is not defined in object type {}'){
                $found2 = $true
                Write-Host "found nr 2"
              }
            }
             
            Write-Host "----------------------------------------------------------------------------------------------"   
          }

          if (!$found1){
            Write-Host "Error finding the first expected result. Exiting with failure"
          } 
          else {
            Write-Host "Found first the expected error succesfully"
          }

          if (!$found2){
            Write-Host "Error finding the second expected result. Exiting with failure"
          } 
          else {
            Write-Host "Found the second expected error succesfully"
          }

          if (!$found1 || !found2){
            exit 1
          }
